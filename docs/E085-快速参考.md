# E085 AI生成功能 - 快速参考

## 核心流程

```
用户点击AI按钮 → 验证主题 → 加载提示词模板 → 替换占位符 → 调用AI API → 流式显示结果 → 确认回填
```

## 关键文件

| 文件 | 作用 |
|------|------|
| `frontend/src/components/SixElementCard.tsx` | 六要素卡片，包含AI生成按钮 |
| `frontend/src/components/AICreating.tsx` | AI生成弹窗组件，处理生成流程 |
| `frontend/src/utils/promptTemplates.ts` | 提示词模板加载和占位符替换工具 |
| `frontend/src/pages/TemplatePage.tsx` | 主页面，集成所有组件 |
| `frontend/public/docs/提示词-*.md` | 6个提示词模板文件 |

## 提示词模板文件

| 文件名 | 用途 | 占位符 |
|--------|------|--------|
| 提示词-任务目标.md | 生成任务目标 | `{{topic}}` |
| 提示词-AI的角色.md | 生成AI角色 | `{{topic}}`, `{{task}}` |
| 提示词-我的角色.md | 生成我的角色 | `{{topic}}`, `{{task}}` |
| 提示词-关键信息.md | 生成关键信息 | `{{topic}}`, `{{task}}`, `{{ai_role}}` |
| 提示词-行为规则.md | 生成行为规则 | `{{topic}}`, `{{task}}`, `{{ai_role}}`, `{{key_info}}` |
| 提示词-交付格式.md | 生成交付格式 | `{{topic}}`, `{{task}}`, `{{key_info}}`, `{{behavior}}` |

## 占位符依赖关系

```
topic (主题)
  ↓
task (任务目标)
  ↓
ai_role (AI角色) + my_role (我的角色)
  ↓
key_info (关键信息)
  ↓
behavior (行为规则)
  ↓
delivery (交付格式)
```

## 验证检查点

### 点击AI按钮前

1. ✅ 主题不为空
2. ✅ 提示词模板已加载
3. ✅ 提示词模板不是HTML内容

### AI生成过程中

1. ✅ 获取到可用的API配置
2. ✅ 占位符正确替换
3. ✅ API调用成功
4. ✅ 流式响应正常显示

### 生成完成后

1. ✅ 内容正确回填到对应卡片
2. ✅ 弹窗正确关闭

## 常见错误及解决

| 错误提示 | 原因 | 解决方案 |
|---------|------|---------|
| "请先输入主题后再使用AI生成功能" | 主题为空 | 先输入主题 |
| "提示词模板未加载，请稍后重试" | 模板文件不存在或加载失败 | 检查 `frontend/public/docs/` 目录 |
| "提示词模板加载错误，请刷新页面重试" | 模板内容为HTML | 检查文件路径和服务器配置 |
| "未找到可用的API配置..." | 没有启用的API Provider | 在API配置页面添加并启用Provider |

## 调试命令

### 1. 检查模板文件是否存在

```bash
ls -la frontend/public/docs/提示词-*.md
```

### 2. 查看模板内容

```bash
cat frontend/public/docs/提示词-任务目标.md
```

### 3. 测试模板访问

在浏览器中访问：

- `http://localhost:3000/docs/提示词-任务目标.md`

### 4. 查看控制台日志

打开浏览器开发者工具（F12），查看Console标签：

- 模板加载日志：`Loaded template for task: SUCCESS`
- 占位符替换日志：`Replacing placeholders in template:`
- 最终提示词：`最终提示词:`

## 代码示例

### 在SixElementCard中使用AI生成

```typescript
<SixElementCard
  title="任务目标"
  value={templateData.taskObjective}
  onChange={(value) => handleInputChange('taskObjective', value)}
  promptTemplate={promptTemplates.task}
  placeholders={generatePlaceholders('task', {
    topic: templateData.topic,
  })}
/>
```

### 手动测试占位符替换

```javascript
// 在浏览器控制台执行
const template = "主题：{{topic}}\n任务：{{task}}";
const placeholders = { topic: "测试主题", task: "测试任务" };

let result = template;
Object.entries(placeholders).forEach(([key, value]) => {
  const placeholder = `{{${key}}}`;
  result = result.replace(new RegExp(placeholder, 'g'), value);
});

console.log(result);
```

## 注意事项

⚠️ **重要**：

1. 文件名是 `提示词-交付格式.md`，不是 `提示词-输出格式.md`
2. 模板文件必须放在 `frontend/public/docs/` 目录
3. 访问路径是 `/docs/提示词-xxx.md`，不包含 `public`
4. 主题为空时AI按钮不可用
5. 需要至少一个已启用的API Provider配置

## 下一步优化

- [x] 批量生成：一键生成所有六要素 ✅
- [x] 参数调整：支持调整temperature、max_tokens等参数 ✅
- [ ] 模板管理：支持用户自定义提示词模板
- [ ] 历史记录：保存AI生成的历史记录
- [ ] 多模型选择：允许用户选择使用哪个API Provider（已实现基础功能）
