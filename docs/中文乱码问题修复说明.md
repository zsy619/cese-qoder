# 中文乱码问题修复说明

## 问题描述

接口 `/api/v1/api-provider` 返回的 `api_remark` 字段（备注说明）出现中文乱码。

**症状示例：**
```json
{
  "api_remark": "DeepSeekå®˜æ–¹API-ç§æœ‰"  // 应该是 "DeepSeek官方API-私有"
}
```

## 问题分析

### 1. 根本原因

中文乱码是由于**字符集不匹配**导致的，具体表现为：

1. **数据库层面**：数据被**双重编码**存储
   - 插入数据时使用了 `latin1` 字符集连接
   - UTF-8 编码的中文被当作 Latin1 存储，再次编码为 UTF-8
   - 导致一个中文字符变成了多个错误字符

2. **连接层面**：MySQL 客户端字符集设置错误
   - `character_set_client`: latin1 ❌（应该是 utf8mb4）
   - `character_set_connection`: latin1 ❌（应该是 utf8mb4）
   - `character_set_results`: latin1 ❌（应该是 utf8mb4）

### 2. 问题定位过程

```bash
# 1. 测试接口返回
curl -X GET "http://localhost:8080/api/v1/api-provider" | jq '.data.list[0].api_remark'
# 输出：乱码

# 2. 检查数据库中的数据
docker exec -i mysql mysql -uroot -p123456 -e "SELECT api_remark FROM context_engine.cese_api_provider LIMIT 1;"
# 输出：正常显示中文

# 3. 检查数据的十六进制值
docker exec -i mysql mysql -uroot -p123456 -e "SELECT HEX(api_remark) FROM context_engine.cese_api_provider LIMIT 1;"
# 输出：C3A5C2AE... （双重编码）

# 4. 检查 MySQL 字符集变量
docker exec -i mysql mysql -uroot -p123456 -e "SHOW VARIABLES LIKE 'character_set%';"
# 发现：character_set_client/connection/results 都是 latin1
```

## 解决方案

### 1. 修改数据库连接配置（✅ 已完成）

**文件：** [`backend/config/db.go`](../backend/config/db.go)

#### 修改前：
```go
dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=%s&parseTime=True&loc=Local",
    config.User,
    config.Password,
    config.Host,
    config.Port,
    config.DBName,
    config.Charset, // 从配置文件读取，可能不一致
)
```

#### 修改后：
```go
// charset=utf8mb4 参数会设置 connection 的字符集，确保正确处理中文
dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&collation=utf8mb4_unicode_ci&parseTime=True&loc=Local",
    config.User,
    config.Password,
    config.Host,
    config.Port,
    config.DBName,
)

// 连接成功后，显式设置字符集
if err := DB.Exec("SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci").Error; err != nil {
    return fmt.Errorf("failed to set character set: %w", err)
}
```

**关键改动：**
1. 强制使用 `charset=utf8mb4`，不从配置文件读取
2. 添加 `collation=utf8mb4_unicode_ci` 参数
3. 连接后执行 `SET NAMES utf8mb4` 确保字符集正确

### 2. 修复已存储的错误数据（✅ 已完成）

#### 方法一：使用迁移脚本（推荐）

**文件：** [`docker/migrations/003_fix_test_data.sql`](../docker/migrations/003_fix_test_data.sql)

```bash
# 执行迁移脚本
docker exec -i mysql mysql -uroot -p123456 --default-character-set=utf8mb4 context_engine \
  < docker/migrations/003_fix_test_data.sql
```

**重要：** 必须使用 `--default-character-set=utf8mb4` 参数！

#### 方法二：直接在数据库中执行

```sql
-- 使用 utf8mb4 连接
USE context_engine;

-- 转换表字符集
ALTER TABLE cese_api_provider CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 删除旧数据并重新插入
DELETE FROM cese_api_provider WHERE mobile IN ('13800138000', '13900139000');

INSERT INTO cese_api_provider (mobile, name, api_key, api_url, api_model, api_version, api_status, api_open, api_remark) VALUES
('13800138000', 'DeepSeek', 'sk-your-deepseek-key', 'https://api.deepseek.com', 'deepseek-chat', 'v1', 1, 1, 'DeepSeek官方API-私有'),
('13800138000', 'Ollama本地', 'local', 'http://localhost:11434', 'llama2', 'v1', 0, 0, 'Ollama本地部署-公开'),
('13900139000', 'OpenAI', 'sk-your-openai-key', 'https://api.openai.com', 'gpt-4', 'v1', 1, 0, 'OpenAI官方API-私有');
```

### 3. 更新初始化脚本（✅ 已完成）

**文件：** [`docker/init.sql`](../docker/init.sql)

确保所有表和数据库都使用 `utf8mb4` 字符集：

```sql
-- 创建数据库时指定字符集
CREATE DATABASE IF NOT EXISTS context_engine 
DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建表时指定字符集
CREATE TABLE `cese_api_provider` (
  ...
  `api_remark` TEXT COMMENT '备注说明',
  ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='API Provider配置表';

-- 插入数据时使用正确的字符集
-- （确保执行脚本时使用 --default-character-set=utf8mb4）
```

## 验证修复

### 1. 重新编译并重启服务

```bash
cd backend
go build -o bin/cese-qoder main.go
pkill -f 'bin/cese-qoder'
./bin/cese-qoder &
```

### 2. 测试接口

```bash
# 登录获取 token
TOKEN=$(curl -s -X POST http://localhost:8080/api/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"mobile":"13800138000","password":"Test@123456"}' | jq -r '.data.token')

# 测试接口
curl -s -X GET "http://localhost:8080/api/v1/api-provider" \
  -H "Authorization: Bearer $TOKEN" | jq '.data.list[] | {name: .name, api_remark: .api_remark}'
```

**期望输出：**
```json
{
  "name": "DeepSeek",
  "api_remark": "DeepSeek官方API-私有"
}
{
  "name": "Ollama本地",
  "api_remark": "Ollama本地部署-公开"
}
```

### 3. 验证数据库存储

```bash
docker exec -i mysql mysql -uroot -p123456 --default-character-set=utf8mb4 \
  -e "SELECT name, api_remark FROM context_engine.cese_api_provider WHERE mobile='13800138000';"
```

## 最佳实践

### 1. 始终使用 UTF-8MB4

- **数据库创建**：`DEFAULT CHARACTER SET utf8mb4`
- **表创建**：`DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci`
- **连接字符串**：`charset=utf8mb4&collation=utf8mb4_unicode_ci`
- **客户端连接**：`--default-character-set=utf8mb4`

### 2. 为什么是 utf8mb4 而不是 utf8？

MySQL 的 `utf8` 字符集**不是真正的 UTF-8**：
- `utf8`：最多 3 字节，不支持 Emoji 和一些特殊字符
- `utf8mb4`：最多 4 字节，完整支持所有 Unicode 字符（包括 Emoji）

**推荐：** 始终使用 `utf8mb4`！

### 3. 检查字符集的命令

```bash
# 检查数据库字符集
SHOW CREATE DATABASE context_engine;

# 检查表字符集
SHOW CREATE TABLE cese_api_provider;

# 检查字段字符集
SHOW FULL COLUMNS FROM cese_api_provider;

# 检查连接字符集
SHOW VARIABLES LIKE 'character_set%';
```

### 4. 避免双重编码

插入数据时，确保：
1. 连接使用 `utf8mb4` 字符集
2. 数据本身是 UTF-8 编码
3. 不要对已编码的数据再次编码

## 技术要点

### 1. GORM DSN 参数说明

```go
dsn := "user:pass@tcp(host:port)/dbname?charset=utf8mb4&collation=utf8mb4_unicode_ci&parseTime=True&loc=Local"
```

- `charset=utf8mb4`：设置连接字符集
- `collation=utf8mb4_unicode_ci`：设置排序规则（支持大小写不敏感比较）
- `parseTime=True`：自动解析 time.Time 类型
- `loc=Local`：使用本地时区

### 2. SET NAMES 作用

```sql
SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci;
```

等价于：
```sql
SET character_set_client = utf8mb4;
SET character_set_connection = utf8mb4;
SET character_set_results = utf8mb4;
SET collation_connection = utf8mb4_unicode_ci;
```

## 相关文件

- 数据库配置：[`backend/config/db.go`](../backend/config/db.go)
- 初始化脚本：[`docker/init.sql`](../docker/init.sql)
- 迁移脚本：[`docker/migrations/003_fix_test_data.sql`](../docker/migrations/003_fix_test_data.sql)
- 字符集修复：[`docker/migrations/003_fix_chinese_encoding.sql`](../docker/migrations/003_fix_chinese_encoding.sql)

## 总结

### 问题原因
1. 数据库连接字符集未明确指定为 `utf8mb4`
2. 已存储的数据被双重编码

### 解决方案
1. ✅ 修改 DSN，强制使用 `charset=utf8mb4`
2. ✅ 连接后执行 `SET NAMES utf8mb4`
3. ✅ 重新插入正确编码的测试数据

### 验证结果
- 接口返回的中文正常显示 ✅
- 数据库存储的数据正确 ✅
- 新插入的数据不会乱码 ✅

---

**修复日期：** 2025-10-23  
**修复人员：** Qoder AI Assistant
