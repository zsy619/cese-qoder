
## 任务目标
对接大模型API根据主题及相关信息生成相关任务

## AI的角色
高级架构师，具有20多年大厂工作的经验
- 较强的AI IT项目整体设计功能
- 超强的React设计和使用能力
- 了解前后端API交互能力
- 具有超强的AI对接能力

## 我的角色
全栈工程师，具有10多年大厂工作的经验

## 关键信息
- 项目信息：@README.md
- 表结构：@docker/init.sql
- 前端页面：@frontend/src/pages/TemplatePage.tsx
- 提示词模板工具：@frontend/src/utils/promptTemplates.ts
- AI生成组件：@frontend/src/components/AICreating.tsx
- 六要素卡片组件：@frontend/src/components/SixElementCard.tsx
- 各功能对应的提示词模板文件（位于 frontend/public/docs/）：
    - 提示词-任务目标.md - 用于生成任务目标内容
    - 提示词-AI的角色.md - 用于生成AI角色描述
    - 提示词-我的角色.md - 用于生成我的角色描述
    - 提示词-关键信息.md - 用于生成关键信息内容
    - 提示词-行为规则.md - 用于生成行为规则内容
    - 提示词-交付格式.md - 用于生成交付格式描述

## 提示词模板机制说明
1. **模板加载**：通过 `promptTemplates.ts` 中的 `getPromptTemplate()` 函数从 `/docs/` 路径加载对应的 .md 文件
2. **占位符替换**：模板中使用 `{{key}}` 格式的占位符，通过 `generatePlaceholders()` 函数生成替换数据
3. **占位符规则**：
   - 所有模板都包含 `{{topic}}` 占位符（主题）
   - 任务目标：只需要 topic
   - AI的角色：需要 topic, task
   - 我的角色：需要 topic, task
   - 关键信息：需要 topic, task, ai_role
   - 行为规则：需要 topic, task, ai_role, key_info
   - 交付格式：需要 topic, task, key_info, behavior
4. **模板验证**：
   - 检查模板是否为空
   - 检查模板是否为HTML内容（错误页面）
   - 确保模板内容为有效的Markdown格式

## 行为规则
- 严格验证当前项目的功能进行修订
- 确定增加功能的正确性，否则拒绝修改
- 拒绝修改其他页面和功能

## 交付格式

### 1. SixElementCard组件增强（已完成）
**位置**：`frontend/src/components/SixElementCard.tsx`

**新增Props**：
- `promptTemplate?: string` - 提示词模板内容
- `placeholders?: Record<string, string>` - 替换占位符的数据

**AI生成按钮**：
- 位置：放在全屏按钮的左侧
- 图标：AI对话框样式图标
- 点击前验证：
  1. 检查主题是否为空，为空则Toast提示"请先输入主题后再使用AI生成功能"
  2. 检查提示词模板是否存在，不存在则Toast提示"提示词模板未加载，请稍后重试"
  3. 检查提示词模板是否为HTML内容，是则Toast提示"提示词模板加载错误，请刷新页面重试"
- 点击后：显示AICreating组件

### 2. AICreating组件（已完成）
**位置**：`frontend/src/components/AICreating.tsx`

**Props接口**：
```typescript
interface AICreatingProps {
    visible: boolean;              // 是否显示组件
    onClose: () => void;           // 关闭组件的回调
    title: string;                 // 组件标题（如：任务目标、AI的角色等）
    promptTemplate: string;        // 提示词模板内容
    placeholders: Record<string, string>;  // 替换占位符的数据
    onSuccess: (content: string) => void;  // 生成成功的回调
}
```

**生成流程**：
1. **验证阶段**：
   - 验证提示词模板是否存在且不为空
   - 验证提示词模板是否为HTML内容（错误页面）
   
2. **获取API配置**：
   - 调用 `APIProviderService.getEnabled()` 获取已启用的API配置
   - 如果不存在，Toast提示"未找到可用的API配置，请先在API配置页面添加并启用至少一个Provider"
   - 使用第一个可用的配置

3. **替换占位符**：
   - 使用 `replacePlaceholders()` 函数替换模板中的 `{{key}}` 占位符
   - 将替换后的完整提示词发送给AI

4. **调用AI接口**：
   - 调用 `AIService.generateViaBackend()` 进行流式生成
   - 支持实时显示生成内容（流式响应）

5. **状态显示**：
   - `thinking`：显示"正在准备..."和加载动画
   - `generating`：显示"AI正在生成内容..."和生成指示器，实时显示生成内容
   - `success`：显示完整生成内容，可编辑
   - `error`：显示错误信息和重试按钮

**操作按钮**：
- **继续生成**（成功状态）：重新发起请求，更新显示内容
- **重试**（错误状态）：重新发起请求
- **确定**：将生成的内容通过 `onSuccess` 回调返回给父组件，关闭弹窗
- **取消**：关闭弹窗，不保存任何内容

### 3. TemplatePage页面集成（已完成）
**位置**：`frontend/src/pages/TemplatePage.tsx`

**提示词模板加载**：
```typescript
useEffect(() => {
    clearTemplateCache();  // 清除缓存确保重新加载
    const loadTemplates = async () => {
        const templates: Record<string, string> = {};
        const elementTypes: ElementType[] = ['task', 'ai_role', 'my_role', 'key_info', 'behavior', 'delivery'];
        
        for (const type of elementTypes) {
            const template = await getPromptTemplate(type);
            templates[type] = template;
        }
        
        setPromptTemplates(templates as Record<ElementType, string>);
    };
    loadTemplates();
}, []);
```

**传递给SixElementCard**：
```typescript
<SixElementCard
    title="任务目标"
    value={templateData.taskObjective}
    onChange={(value) => handleInputChange('taskObjective', value)}
    promptTemplate={promptTemplates.task}
    placeholders={generatePlaceholders('task', {
        topic: templateData.topic,
    })}
/>
```

### 4. 提示词模板工具（已完成）
**位置**：`frontend/src/utils/promptTemplates.ts`

**核心函数**：
- `getPromptTemplate(elementType)` - 从 `/docs/` 路径加载对应的 .md 文件
- `generatePlaceholders(elementType, data)` - 根据要素类型生成占位符数据
- `replacePlaceholders(template, placeholders)` - 替换模板中的占位符
- `clearTemplateCache()` - 清除模板缓存

### 5. 验证清单
- [x] 提示词模板文件存在且内容正确
- [x] 模板加载机制正常工作
- [x] 占位符替换逻辑正确
- [x] AI生成按钮显示在正确位置
- [x] 点击前验证逻辑完整
- [x] AICreating组件流式显示正常
- [x] 生成成功后内容正确回填
- [x] 错误处理和Toast提示完善


## 常见问题诊断

### 问题1：提示词模板未加载或为空
**症状**：点击AI生成按钮后提示"提示词模板未加载"

**原因分析**：
1. 模板文件路径不正确
2. 模板文件不存在
3. fetch请求返回404或其他错误
4. 模板内容为空

**解决方案**：
1. 检查文件是否存在于 `frontend/public/docs/` 目录
2. 确认文件名与 `TEMPLATE_PATHS` 中的映射一致
3. 打开浏览器开发者工具，查看Network标签，确认请求路径和响应
4. 检查控制台日志，查看 `getPromptTemplate()` 的输出

### 问题2：提示词模板加载为HTML内容
**症状**：点击AI生成按钮后提示"提示词模板加载错误"

**原因分析**：
1. 文件路径错误，返回了404错误页面（HTML格式）
2. 服务器配置问题，返回了默认页面

**解决方案**：
1. 确认文件路径：应该是 `/docs/提示词-xxx.md`，不是 `/frontend/public/docs/`
2. 检查 `public` 目录的静态资源配置
3. 在浏览器中直接访问 `http://localhost:3000/docs/提示词-任务目标.md`，确认能正常访问

### 问题3：占位符未被替换
**症状**：AI生成时提示词中仍然包含 `{{topic}}` 等占位符

**原因分析**：
1. `placeholders` 数据未正确传递
2. `generatePlaceholders()` 函数逻辑错误
3. `replacePlaceholders()` 函数替换逻辑错误

**解决方案**：
1. 在 `SixElementCard` 中添加日志，检查传入的 `placeholders` 值
2. 在 `AICreating` 中添加日志，检查替换前后的提示词内容
3. 确认占位符格式为 `{{key}}`，不是 `{key}` 或其他格式

### 问题4：AI生成失败
**症状**：显示"API调用失败"或其他错误信息

**原因分析**：
1. 没有可用的API配置
2. API配置未启用
3. API密钥无效
4. 网络连接问题
5. 后端服务未启动

**解决方案**：
1. 检查API Provider配置页面，确保至少有一个启用的配置
2. 测试API配置是否有效
3. 检查后端服务是否正常运行
4. 查看浏览器控制台和后端日志，定位具体错误

## 调试技巧

### 1. 启用详细日志
在相关组件中添加 `console.log` 输出关键信息：

```typescript
// SixElementCard.tsx - handleAIGenerate()
console.log('AI Generate button clicked with:', {
    title,
    promptTemplate: promptTemplate ? promptTemplate.substring(0, 100) + '...' : 'EMPTY',
    placeholders
});

// AICreating.tsx - generateContent()
console.log('AICreating received props:', {
    title,
    promptTemplate: promptTemplate ? promptTemplate.substring(0, 100) + '...' : 'EMPTY',
    placeholders
});
console.log('最终提示词:', finalPrompt);

// promptTemplates.ts - getPromptTemplate()
console.log(`Fetching template from path: ${path}`);
console.log(`Raw template content for ${elementType}:`, content.substring(0, 200));
```

### 2. 检查Network请求
1. 打开浏览器开发者工具（F12）
2. 切换到Network标签
3. 筛选 `.md` 文件
4. 点击AI生成按钮
5. 查看请求的URL、状态码和响应内容

### 3. 验证提示词模板
直接在浏览器中访问模板文件：
- http://localhost:3000/docs/提示词-任务目标.md
- http://localhost:3000/docs/提示词-AI的角色.md
- http://localhost:3000/docs/提示词-我的角色.md
- http://localhost:3000/docs/提示词-关键信息.md
- http://localhost:3000/docs/提示词-行为规则.md
- http://localhost:3000/docs/提示词-交付格式.md

如果返回404或HTML页面，说明路径配置有问题。

### 4. 测试占位符替换
在浏览器控制台中手动测试：

```javascript
const template = "主题：{{topic}}\n任务：{{task}}";
const placeholders = { topic: "测试主题", task: "测试任务" };

let result = template;
Object.entries(placeholders).forEach(([key, value]) => {
    const placeholder = `{{${key}}}`;
    result = result.replace(new RegExp(placeholder, 'g'), value);
});

console.log(result);
// 应该输出：主题：测试主题\n任务：测试任务
```

## 实现状态总结

✅ **已完成**：
1. SixElementCard组件增加AI生成按钮
2. AICreating组件实现流式生成
3. 提示词模板加载机制
4. 占位符替换逻辑
5. 错误处理和Toast提示
6. TemplatePage页面集成

⚠️ **注意事项**：
1. 确保提示词模板文件名为"提示词-交付格式.md"，不是"提示词-输出格式.md"
2. 模板文件必须放在 `frontend/public/docs/` 目录
3. 访问路径为 `/docs/提示词-xxx.md`，不包含 `public`
4. 主题为空时不允许点击AI生成按钮
5. 需要至少一个已启用的API Provider配置

## 下一步优化建议

1. **批量生成**：添加"一键生成全部"按钮，自动生成所有六要素
2. **模板管理**：支持用户自定义提示词模板
3. **历史记录**：保存AI生成的历史记录，支持回退
4. **多模型选择**：允许用户选择使用哪个API Provider
5. **参数调整**：支持调整temperature、max_tokens等参数
